#!/system/bin/sh
# version 1.3

#Create logfile
if [ ! -e /sdcard/vm.log ] ;then
    touch /sdcard/vm.log
fi
echo "" >> /sdcard/vm.log
echo "`date +%Y-%m-%d_%T` Device rebooted" >> /sdcard/vm.log

#wait on internet
until ping -c1 8.8.8.8 >/dev/null 2>/dev/null; do
    sleep 10
done
echo "`date +%Y-%m-%d_%T` Internet connection available" >> /sdcard/vm.log

#update vmapper.sh and 55vmapper
old55=$(head -5 /system/etc/init.d/55vmapper | grep '# version' | awk '{ print $NF }')
oldsh=$(grep '# version' /system/bin/vmapper.sh | awk '{ print $NF }')

mount -o remount,rw /system

if [ -f /sdcard/useVMCdevelop ]; then
        /system/bin/curl -s -k -L -o /system/bin/vmapper.sh https://raw.githubusercontent.com/v-mapper/vmconf/develop/vmapper.sh
        chmod +x /system/bin/vmapper.sh
        /system/bin/curl -s -k -L -o /system/etc/init.d/55vmapper https://raw.githubusercontent.com/v-mapper/vmconf/develop/55vmapper
        chmod +x /system/etc/init.d/55vmapper
	else
        /system/bin/curl -s -k -L -o /system/bin/vmapper.sh https://raw.githubusercontent.com/v-mapper/vmconf/main/vmapper.sh
        chmod +x /system/bin/vmapper.sh
        /system/bin/curl -s -k -L -o /system/etc/init.d/55vmapper https://raw.githubusercontent.com/v-mapper/vmconf/main/55vmapper
        chmod +x /system/etc/init.d/55vmapper
fi

mount -o remount,ro /system

new55=$(head -5 /system/etc/init.d/55vmapper | grep '# version' | awk '{ print $NF }')
newsh=$(grep '# version' /system/bin/vmapper.sh | awk '{ print $NF }')
if [[ $old55 != $new55 || $oldsh != $newsh ]] ;then
  echo "`date +%Y-%m-%d_%T` 55vmapper $old55=>$new55, vmapper.sh $oldsh=>$newsh" >> /sdcard/vm.log
fi

# have vmapper.sh check for updated vmapper version in wizzard
! [[ -f /sdcard/disableautovmapperupdate ]] && sh -x /system/bin/vmapper.sh -uvw
